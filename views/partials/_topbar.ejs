<div class="topbar">
    <h1 onclick="window.location.href='/index'">CryptoFantasy</h1>
    <div class="user-info">
        <span id="username">Loading...</span>

        <div id="league-container" style="display: none; align-items: center; gap: 8px;">
            <span style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.06em;">
                League
            </span>
            <select id="league-select"
                    style="
                        padding: 6px 10px;
                        border-radius: 999px;
                        border: 1px solid rgba(255,255,255,0.2);
                        background: rgba(15,23,36,0.9);
                        color: #e6eef8;
                        font-size: 13px;
                        cursor: pointer;
                        min-width: 160px;
                    ">
            </select>
        </div>
    </div>
</div>

<script>
    (async () => {
        try {
            const meRes = await fetch("/api/me");
            if (meRes.ok) {
                const data = await meRes.json();
                document.getElementById("username").textContent = data.user.username;
            }

            const leaguesRes = await fetch("/api/leagues/active");
            if (!leaguesRes.ok) return;

            const leaguesData = await leaguesRes.json();
            const { leagues = [], activeLeagueId, activeLeague } = leaguesData;

            const container = document.getElementById("league-container");
            const select = document.getElementById("league-select");

            if (!leagues.length) {
                return;
            }

            container.style.display = "flex";

            leagues.forEach(l => {
                const opt = document.createElement("option");
                opt.value = l.id;
                opt.textContent = l.name;
                if (activeLeagueId && Number(activeLeagueId) === Number(l.id)) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });

            if (!activeLeagueId && leagues.length && !select.value) {
                select.value = String(leagues[0].id);
            }

            select.addEventListener("change", async (e) => {
                const leagueId = e.target.value;
                try {
                    await fetch("/api/leagues/active", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ leagueId })
                    });
                    window.location.reload();
                } catch (err) {
                    console.error("Error setting active league:", err);
                }
            });
        } catch (e) {
            console.error("Error initializing topbar:", e);
        }
    })();
</script>
